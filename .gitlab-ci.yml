# GitLab CI/CD Pipeline for Eclexia
# Multi-stage pipeline with validation, testing, and deployment

variables:
  DENO_VERSION: "1.40.0"
  DENO_DIR: ".deno_cache"

# Cache Deno dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ${DENO_DIR}
    - node_modules/

# Pipeline stages
stages:
  - validate
  - test
  - build
  - analyze
  - deploy

# Default configuration for all jobs
default:
  image: denoland/deno:${DENO_VERSION}
  before_script:
    - deno --version
    - export DENO_DIR=$PWD/${DENO_DIR}

# ============================================================================
# Validation Stage
# ============================================================================

format-check:
  stage: validate
  script:
    - deno fmt --check
  only:
    - merge_requests
    - main

lint:
  stage: validate
  script:
    - deno lint
  only:
    - merge_requests
    - main

type-check:
  stage: validate
  script:
    - deno check src/**/*.ts
  only:
    - merge_requests
    - main

# RSR Compliance Check
rsr-compliance:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache bash
  script:
    - |
      echo "Checking RSR Silver compliance..."
      MISSING=0

      # Community Health Files
      for file in LICENSE.txt SECURITY.md CONTRIBUTING.md CODE_OF_CONDUCT.md MAINTAINERS.md CHANGELOG.md; do
        if [ -f "$file" ]; then
          echo "✓ $file"
        else
          echo "✗ $file MISSING"
          MISSING=1
        fi
      done

      # .well-known files
      for file in security.txt ai.txt humans.txt; do
        if [ -f ".well-known/$file" ]; then
          echo "✓ .well-known/$file"
        else
          echo "✗ .well-known/$file MISSING"
          MISSING=1
        fi
      done

      # Build files
      for file in justfile .gitlab-ci.yml; do
        if [ -f "$file" ]; then
          echo "✓ $file"
        else
          echo "✗ $file MISSING"
          MISSING=1
        fi
      done

      # Framework files
      for file in TPCF.md RSR_AUDIT.md; do
        if [ -f "$file" ]; then
          echo "✓ $file"
        else
          echo "✗ $file MISSING"
          MISSING=1
        fi
      done

      if [ $MISSING -eq 1 ]; then
        echo "RSR compliance check FAILED"
        exit 1
      else
        echo "RSR compliance check PASSED"
      fi
  only:
    - merge_requests
    - main

# Validate security.txt per RFC 9116
validate-security-txt:
  stage: validate
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "Validating security.txt per RFC 9116..."
      if [ ! -f ".well-known/security.txt" ]; then
        echo "ERROR: security.txt not found"
        exit 1
      fi

      # Check required fields
      grep -q "^Contact:" .well-known/security.txt || (echo "Missing Contact field" && exit 1)
      grep -q "^Expires:" .well-known/security.txt || (echo "Missing Expires field" && exit 1)

      echo "security.txt validation PASSED"
  only:
    - merge_requests
    - main

# ============================================================================
# Test Stage
# ============================================================================

unit-tests:
  stage: test
  script:
    - deno test --allow-read --allow-write --coverage=coverage
  coverage: '/^\s*lines[\.]+:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura.xml
    paths:
      - coverage/
    expire_in: 1 week
  only:
    - merge_requests
    - main

integration-tests:
  stage: test
  script:
    - echo "Running integration tests..."
    - deno test --allow-read --allow-write --allow-net tests/integration/
  only:
    - merge_requests
    - main
  allow_failure: true  # Optional if integration tests not fully implemented

# Test examples run successfully
example-tests:
  stage: test
  script:
    - |
      echo "Testing example programs..."
      for file in examples/*.ecx; do
        if [ -f "$file" ]; then
          echo "Running $file..."
          deno run --allow-read src/cli/main.ts "$file" || exit 1
        fi
      done
      echo "All examples passed!"
  only:
    - merge_requests
    - main
  allow_failure: true  # Examples might not exist yet

# ============================================================================
# Build Stage
# ============================================================================

bundle:
  stage: build
  script:
    - deno bundle src/mod.ts dist/eclexia.js
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  only:
    - main
    - tags

compile-linux:
  stage: build
  script:
    - deno compile --allow-read --allow-write --target x86_64-unknown-linux-gnu --output=bin/eclexia-linux src/cli/main.ts
  artifacts:
    paths:
      - bin/
    expire_in: 1 month
  only:
    - tags

compile-macos:
  stage: build
  script:
    - deno compile --allow-read --allow-write --target x86_64-apple-darwin --output=bin/eclexia-macos src/cli/main.ts
  artifacts:
    paths:
      - bin/
    expire_in: 1 month
  only:
    - tags
  allow_failure: true

compile-windows:
  stage: build
  script:
    - deno compile --allow-read --allow-write --target x86_64-pc-windows-msvc --output=bin/eclexia-windows.exe src/cli/main.ts
  artifacts:
    paths:
      - bin/
    expire_in: 1 month
  only:
    - tags
  allow_failure: true

# ============================================================================
# Analysis Stage
# ============================================================================

code-coverage:
  stage: analyze
  dependencies:
    - unit-tests
  script:
    - deno coverage coverage --lcov --output=coverage.lcov
    - |
      COVERAGE=$(deno coverage coverage | grep "cover" | awk '{print $NF}' | tr -d '%')
      echo "Code coverage: ${COVERAGE}%"

      # Fail if coverage below 70%
      if [ $(echo "$COVERAGE < 70" | bc) -eq 1 ]; then
        echo "ERROR: Coverage ${COVERAGE}% is below 70% threshold"
        exit 1
      fi
  artifacts:
    paths:
      - coverage.lcov
    expire_in: 1 week
  only:
    - merge_requests
    - main
  allow_failure: true  # Don't block pipeline on coverage initially

code-quality:
  stage: analyze
  script:
    - |
      echo "Analyzing code quality..."

      # Count TODO and FIXME
      TODO_COUNT=$(grep -r "TODO" src/ | wc -l)
      FIXME_COUNT=$(grep -r "FIXME" src/ | wc -l)

      echo "TODO items: $TODO_COUNT"
      echo "FIXME items: $FIXME_COUNT"

      # Fail if too many FIXMEs
      if [ $FIXME_COUNT -gt 10 ]; then
        echo "WARNING: Too many FIXME comments ($FIXME_COUNT)"
      fi

      # Count lines of code
      LOC=$(find src -name "*.ts" | xargs wc -l | tail -1 | awk '{print $1}')
      echo "Total lines of code: $LOC"
  only:
    - merge_requests
    - main
  allow_failure: true

# Dependency security audit
security-audit:
  stage: analyze
  script:
    - |
      echo "Running security audit..."
      # Check for known vulnerabilities in dependencies
      deno info src/mod.ts

      # Future: integrate with vulnerability databases
      echo "Security audit complete"
  only:
    - merge_requests
    - main
  allow_failure: true

# ============================================================================
# Deploy Stage
# ============================================================================

# Generate documentation
pages:
  stage: deploy
  script:
    - deno doc --html --name=Eclexia --output=public/ src/mod.ts
    - cp README.md public/
    - cp CHANGELOG.md public/
  artifacts:
    paths:
      - public/
  only:
    - main

# Publish to JSR (Deno registry)
publish-jsr:
  stage: deploy
  script:
    - |
      echo "Publishing to JSR..."
      # Future: deno publish
      echo "JSR publish would run here"
  only:
    - tags
  when: manual
  allow_failure: true

# Create GitHub release
create-release:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "Creating GitHub release for ${CI_COMMIT_TAG}..."
      # Future: Use GitHub API to create release
      echo "Release creation would run here"
  only:
    - tags
  when: manual
  allow_failure: true

# ============================================================================
# Scheduled Jobs
# ============================================================================

# Nightly full test suite
nightly-tests:
  stage: test
  script:
    - deno task ci
    - deno bench --allow-read
  only:
    - schedules
  allow_failure: true

# Weekly dependency check
dependency-update-check:
  stage: validate
  script:
    - |
      echo "Checking for dependency updates..."
      deno info src/mod.ts
      # Future: automated dependency updates
  only:
    - schedules
  allow_failure: true

# ============================================================================
# Manual Jobs
# ============================================================================

# Manual benchmark run
benchmark:
  stage: analyze
  script:
    - deno bench --allow-read --json > benchmarks/results.json
  artifacts:
    paths:
      - benchmarks/
    expire_in: 1 month
  when: manual
  only:
    - main

# Manual performance profiling
profile:
  stage: analyze
  script:
    - |
      echo "Running performance profiling..."
      # Future: add profiling scripts
  when: manual
  only:
    - main
  allow_failure: true
